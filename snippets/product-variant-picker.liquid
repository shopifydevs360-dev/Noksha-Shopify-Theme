{% doc %}
  Renders the product variant selector based on global theme settings.

  Uses the following global settings from config/settings_schema.json:
  - variant_option_design_default: default design when no specific match is found
  - variant_option_title[1-5]: option names to match against product.options
  - variant_option_design[1-5]: design per matched option (default, color, image, button, dropdown)
  - variant_option_display_name[1-5]: optional alternative label for the option legend

  Matching is done case-insensitively by option name.

  Designs:
  - dropdown: renders a <select> for the option
  - button: renders text buttons (radio inputs)
  - color: renders color swatches (radio inputs)
  - image: renders image swatches using the matched variant's featured_media
  - default: falls back to a custom-image style (image if available, otherwise text)

  Expected to be rendered inside a product form context where `product` is available.

  @example
  {% render 'product-variant-selector', product: product %}
{% enddoc %}

{% assign current_product = product | default: all_products[product.handle] %}

{% unless current_product.has_only_default_variant %}
  <div class="main-product-variant-selector">
    {% for option in current_product.options_with_values %}
      {% assign option_name = option.name %}
      {% assign option_name_downcase = option_name | downcase %}

      {% assign matched_design = settings.variant_option_design_default %}
      {% assign matched_display_name = '' %}

      {% for i in (1..5) %}
        {% assign title_setting_id = 'variant_option_title' | append: i %}
        {% assign design_setting_id = 'variant_option_design' | append: i %}
        {% assign display_setting_id = 'variant_option_display_name' | append: i %}

        {% assign title_setting_value = settings[title_setting_id] | downcase %}

        {% if title_setting_value != '' and title_setting_value == option_name_downcase %}
          {% assign matched_design = settings[design_setting_id] %}
          {% assign matched_display_name = settings[display_setting_id] %}
        {% endif %}
      {% endfor %}

      {% assign option_label = option_name %}
      {% if matched_display_name != '' %}
        {% assign option_label = matched_display_name %}
      {% endif %}

      {% assign option_index0 = forloop.index0 %}
      {% assign option_position = option.position %}
      {% assign option_key = 'option' | append: option_position %}

      <fieldset class="variant-group" data-option-index="{{ option_index0 }}">
        <legend>
  <span class="option-name">{{ option_label }}:</span>
  <span class="selected-value" data-selected-value>
    {{ option.selected_value }}
  </span>
</legend>

        {% case matched_design %}
          {% when 'dropdown' %}
            <div class="variant-dropdown-wrapper">
              <select
                class="variant-dropdown"
                name="options[{{ option_name }}]"
                data-option-position="{{ option_position }}"
              >
                {% for value in option.values %}
                  <option
                    value="{{ value }}"
                    {% if option.selected_value == value %}selected{% endif %}
                  >
                    {{ value }}
                  </option>
                {% endfor %}
              </select>
            </div>


            {% when 'color' %}
            <div class="variant-buttons is-color" data-option-position="{{ option_position }}">
                {% for value in option.values %}
                
                {% assign color_hex = blank %}

                {% if value.swatch and value.swatch.color %}
                    {% assign color_hex = value.swatch.color %}
                {% endif %}

                {% if color_hex == blank %}
                    {% assign color_hex = value %}
                {% endif %}

                <label class="variant-btn variant-color">
                    <input
                    type="radio"
                    name="options[{{ option_name }}]"
                    value="{{ value }}"
                    {% if option.selected_value == value %}checked{% endif %}
                    >
                    <span
                    class="color-swatch"
                    style="background-color: {{ color_hex }};"
                    title="{{ value }}"
                    ></span>
                </label>
                {% endfor %}
            </div>


          {% when 'image' %}
            <div class="variant-buttons is-image" data-option-position="{{ option_position }}">
              {% for value in option.values %}
                {% assign variants_for_value = current_product.variants | where: option_key, value %}
                {% assign variant_for_value = variants_for_value | first %}

                <label class="variant-btn variant-image">
                  <input
                    type="radio"
                    name="options[{{ option_name }}]"
                    value="{{ value }}"
                    {% if option.selected_value == value %}checked{% endif %}
                  >

                  {% if variant_for_value and variant_for_value.featured_media %}
                    {{ variant_for_value.featured_media
                      | image_url: width: 80, height: 80, crop: 'center'
                      | image_tag: class: 'variant-image-thumb', alt: value
                    }}
                  {% else %}
                    <span class="variant-text">{{ value }}</span>
                  {% endif %}
                </label>
              {% endfor %}
            </div>

          {% when 'button' %}
            <div class="variant-buttons" data-option-position="{{ option_position }}">
              {% for value in option.values %}
                <label class="variant-btn">
                  <input
                    type="radio"
                    name="options[{{ option_name }}]"
                    value="{{ value }}"
                    {% if option.selected_value == value %}checked{% endif %}
                  >
                  <span class="variant-text">{{ value }}</span>
                </label>
              {% endfor %}
            </div>

          {% else %}
            <div class="variant-buttons is-default" data-option-position="{{ option_position }}">
              {% for value in option.values %}
                {% assign variants_for_value = current_product.variants | where: option_key, value %}
                {% assign variant_for_value = variants_for_value | first %}

                <label class="variant-btn variant-default">
                  <input
                    type="radio"
                    name="options[{{ option_name }}]"
                    value="{{ value }}"
                    {% if option.selected_value == value %}checked{% endif %}
                  >

                  {% if variant_for_value and variant_for_value.featured_media %}
                    {{ variant_for_value.featured_media
                      | image_url: width: 80, height: 80, crop: 'center'
                      | image_tag: class: 'variant-image-thumb', alt: value
                    }}
                  {% else %}
                    <span class="variant-text">{{ value }}</span>
                  {% endif %}
                </label>
              {% endfor %}
            </div>
        {% endcase %}
      </fieldset>
    {% endfor %}
  </div>
{% endunless %}

{% stylesheet %}

/* ================================
   VARIANT GROUP
================================ */
.main-product-variant-selector fieldset.variant-group {
  border: 0;
  padding: 0;
  margin: 0 0 1.25rem;
}

.main-product-variant-selector legend {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 0.2rem;
  font-size: 0.95rem;
  font-weight: 600;
  margin-bottom: 0.6rem;
  color: rgb(var(--color-heading));
  letter-spacing: 0.2px;
}

.main-product-variant-selector .selected-value {
  font-weight: 400;
  color: rgb(var(--color-subtext));
  font-size: 0.85rem;
}

/* ================================
   BUTTON WRAPPER
================================ */
.main-product-variant-selector .variant-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 0.6rem;
}

/* ================================
   DROPDOWN
================================ */
.main-product-variant-selector .variant-dropdown {
  width: 100%;
  padding: 0.75rem 1rem;
  border-radius: 6px;
  border: 1px solid rgb(var(--color-border));
  background-color: rgb(var(--color-background));
  font-size: 0.9rem;
  transition: border 0.2s ease;
}

.main-product-variant-selector .variant-dropdown:focus {
  outline: none;
  border-color: rgb(var(--color-heading));
}

/* ================================
   BASE BUTTON STYLE
================================ */
.main-product-variant-selector .variant-btn {
  position: relative;
  cursor: pointer;
}

.main-product-variant-selector .variant-btn input {
  display: none;
}

.main-product-variant-selector .variant-btn span,
.main-product-variant-selector .variant-image-thumb {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 2.75rem;
  min-height: 2.75rem;
  padding: 0.5rem 1rem;
  border-radius: 8px;
  border: 1px solid rgb(var(--color-border));
  background: rgb(var(--color-background));
  font-size: 0.85rem;
  transition: all 0.25s ease;
  box-sizing: border-box;
}

/* Hover */
.main-product-variant-selector 
.variant-btn:not(.stock-out):hover span,
.main-product-variant-selector 
.variant-btn:not(.stock-out):hover .variant-image-thumb {
  border-color: rgb(var(--color-heading));
}

/* Selected */
.main-product-variant-selector 
.variant-btn input:checked + span,
.main-product-variant-selector 
.variant-btn input:checked + .variant-image-thumb {
  border-color: rgb(var(--color-heading));
  background: rgba(var(--color-heading), 0.08);
}

/* ================================
   TEXT BUTTONS
================================ */
.main-product-variant-selector .variant-text {
  text-align: center;
  line-height: 1.2;
}

/* ================================
   COLOR SWATCH
================================ */
.main-product-variant-selector .variant-btn.variant-color .color-swatch {
  width: 2.4rem;
  height: 2.4rem;
  padding: 0;
  border-radius: 50%;
  border: 1px solid #ddd;
}

/* Selected ring */
.main-product-variant-selector 
.variant-btn.variant-color input:checked + .color-swatch {
  box-shadow: 0 0 0 2px rgb(var(--color-heading));
  border-color: #fff;
}

/* ================================
   IMAGE SWATCH
================================ */
.main-product-variant-selector 
.variant-btn.variant-image .variant-image-thumb,
.main-product-variant-selector 
.variant-btn.variant-default .variant-image-thumb {
  width: 3rem;
  height: 3rem;
  padding: 0;
  border-radius: 8px;
  object-fit: cover;
}

/* Image hover scale */
.main-product-variant-selector 
.variant-btn.variant-image:hover .variant-image-thumb {
  transform: scale(1.05);
}

/* ================================
   OUT OF STOCK
================================ */
.main-product-variant-selector .variant-btn.stock-out span,
.main-product-variant-selector .variant-btn.stock-out .variant-image-thumb {
  opacity: 0.4;
  cursor: not-allowed;
  position: relative;
}

.main-product-variant-selector .variant-btn.stock-out span::after,
.main-product-variant-selector .variant-btn.stock-out .variant-image-thumb::after {
  content: "";
  position: absolute;
  width: 70%;
  height: 1px;
  background: currentColor;
  transform: rotate(-25deg);
}

/* ================================
   TRANSITIONS
================================ */
.main-product-variant-selector 
.variant-btn span,
.main-product-variant-selector 
.variant-image-thumb {
  transition: all 0.25s ease;
}

{% endstylesheet %}
