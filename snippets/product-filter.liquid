<form id="CollectionFilters" method="get">

  {% for block in section.blocks %}
    {% case block.type %}

    {%- comment -%}
    ============================
    AVAILABILITY FILTER
    ============================
    {%- endcomment -%}
    {%- when 'availablity-filter' -%}
      <div class="filter-item filter-availability hide">
        {% for filter in collection.filters %}
          {% if filter.label == 'Availability' and filter.values.size > 0 %}
            <fieldset class="filter">
              <legend class="filter-title">Availability</legend>
              <div class="filter-body">
                {% for value in filter.values %}
                  <label>
                    <input
                      type="checkbox"
                      name="{{ value.param_name }}"
                      value="{{ value.value }}"
                      {% if value.active %}checked{% endif %}
                    >
                    {{ value.label }} ({{ value.count }})
                  </label>
                {% endfor %}
              </div>
            </fieldset>
          {% endif %}
        {% endfor %}
      </div>

    {%- comment -%}
    ============================
    VENDOR / BRAND FILTER
    ============================
    {%- endcomment -%}
    {%- when 'vendor-filter' -%}
      <div class="filter-item filter-vendor hide">
        {% for filter in collection.filters %}
          {% if filter.label == 'Vendor' or filter.label == 'Brand' %}
            {% if filter.values.size > 0 %}
              <fieldset class="filter">
                <legend class="filter-title">{{ filter.label }}</legend>
                <div class="filter-body">
                  {% for value in filter.values %}
                    <label>
                      <input
                        type="checkbox"
                        name="{{ value.param_name }}"
                        value="{{ value.value }}"
                        {% if value.active %}checked{% endif %}
                      >
                      {{ value.label }} ({{ value.count }})
                    </label>
                  {% endfor %}
                </div>
              </fieldset>
            {% endif %}
          {% endif %}
        {% endfor %}
      </div>

    {%- comment -%}
    ============================
    COLLECTION FILTER
    ============================
    {%- endcomment -%}
{%- when 'collection-filter' -%}

  {% if collection and collection.handle == 'all' %}

    {% assign menu = linklists[block.settings.collection_menu] %}
    {% if menu and menu.links.size > 0 %}
      <div class="filter-item filter-collection hide">
        <fieldset class="filter accordion-item">
          <legend class="filter-title accordion-trigger">Collections</legend>
          <div class="filter-body accordion-content">
            {% for link in menu.links %}
              {% if link.type == 'collection_link' %}
                <label>
                  <input
                    type="radio"
                    name="collection_handle"
                    value="{{ link.object.handle }}"
                    {% if link.object.handle == collection.handle %}checked{% endif %}
                  >
                  {{ link.title }}
                </label>
              {% endif %}
            {% endfor %}
          </div>
        </fieldset>
      </div>
    {% endif %}

  {% endif %}


    {%- comment -%}
    ============================
    COLOR FILTER
    ============================
    {%- endcomment -%}
    {%- when 'color-filter' -%}
      <div class="filter-item filter-color hide">
        {% for filter in collection.filters %}
          {% if filter.label == 'Color' and filter.values.size > 0 %}
            <fieldset class="filter accordion-item">
              <legend class="filter-title accordion-trigger">Color</legend>
              <div class="filter-body accordion-content">
                {% for value in filter.values %}
                  <label>
                    <input
                      type="checkbox"
                      name="{{ value.param_name }}"
                      value="{{ value.value }}"
                      {% if value.active %}checked{% endif %}
                    >
                    {{ value.label }} ({{ value.count }})
                  </label>
                {% endfor %}
              </div>
            </fieldset>
          {% endif %}
        {% endfor %}
      </div>

    {%- comment -%}
    ============================
    TAG FILTER
    ============================
    {%- endcomment -%}
{%- when 'tag-filter' -%}

  {% assign raw_allowed_tags = block.settings.custom_filter_tags | strip %}
  {% assign allowed_tags = raw_allowed_tags | downcase | split: ',' %}
  {% assign show_tag_filter = false %}

  {%- comment -%}
  First pass: check if ANY tag matches allowed list
  {%- endcomment -%}
  {% for filter in collection.filters %}
    {% if filter.param_name contains '.tag' %}
      {% for value in filter.values %}
        {% assign tag_label = value.label | downcase | strip %}
        {% if raw_allowed_tags == blank or allowed_tags contains tag_label %}
          {% assign show_tag_filter = true %}
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endfor %}

  {% if show_tag_filter %}
    <div class="filter-item filter-tags hide">
      {% for filter in collection.filters %}
        {% if filter.param_name contains '.tag' %}
          <fieldset class="filter accordion-item">
            <legend class="filter-title accordion-trigger">
              {{ block.settings.filter_title }}
            </legend>
            <div class="filter-body accordion-content">
              {% for value in filter.values %}
                {% assign tag_label = value.label | downcase | strip %}
                {% if raw_allowed_tags == blank or allowed_tags contains tag_label %}
                  <label>
                    <input
                      type="checkbox"
                      name="{{ value.param_name }}"
                      value="{{ value.value }}"
                      {% if value.active %}checked{% endif %}
                    >
                    {{ value.label }} ({{ value.count }})
                  </label>
                {% endif %}
              {% endfor %}
            </div>
          </fieldset>
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}


    {%- comment -%}
    ============================
    PRICE FILTER
    ============================
    {%- endcomment -%}
{%- when 'price-filter' -%}
  {% assign show_price = false %}

  {% for filter in collection.filters %}
    {% if filter.type == 'price_range' %}
      {% assign show_price = true %}
    {% endif %}
  {% endfor %}

  {% if show_price %}
    <div class="filter-item filter-price hide">
      {% for filter in collection.filters %}
        {% if filter.type == 'price_range' %}
          <fieldset class="filter">
            <legend class="filter-title">{{ block.settings.filter_title }}</legend>
            <div class="filter-body">

              <label>
                Min
                <input
                  type="number"
                  name="{{ filter.min_value.param_name }}"
                  value="{{ filter.min_value.value }}"
                  min="0"
                  max="{{ filter.range_max }}"
                  placeholder="0"
                >
              </label>

              <label>
                Max
                <input
                  type="number"
                  name="{{ filter.max_value.param_name }}"
                  value="{{ filter.max_value.value }}"
                  min="0"
                  max="{{ filter.range_max }}"
                  placeholder="{{ filter.range_max | divided_by: 100 }}"
                >
              </label>

            </div>
          </fieldset>
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}


    {%- comment -%}
    ============================
    SIZE FILTER
    ============================
    {%- endcomment -%}
    {%- when 'size-filter' -%}
      <div class="filter-item filter-size hide">
        {% for filter in collection.filters %}
          {% if filter.type == 'list' and filter.label == block.settings.filter_title %}
            <fieldset class="filter accordion-item">
              <legend class="filter-title accordion-trigger">{{ block.settings.filter_title }}</legend>
              <div class="filter-body accordion-content">
                {% for value in filter.values %}
                  {% assign short_label = value.label | split: '(' | last | split: ')' | first | strip %}
                  <label>
                    <input
                      type="checkbox"
                      name="{{ value.param_name }}"
                      value="{{ value.value }}"
                      {% if value.active %}checked{% endif %}
                    >
                    {{ short_label }} ({{ value.count }})
                  </label>
                {% endfor %}
              </div>
            </fieldset>
          {% endif %}
        {% endfor %}
      </div>

    {%- comment -%}
    ============================
    SORT FILTER (RADIO STYLE)
    ============================
    {%- endcomment -%}
    {%- when 'sort-filter' -%}
      <div class="filter-item filter-sort hide">
        <fieldset class="filter">
          <legend class="filter-title">{{ block.settings.filter_title }}</legend>
          <div class="filter-body">
            {% for option in collection.sort_options %}
              <label>
                <input
                  type="radio"
                  name="sort_by"
                  value="{{ option.value }}"
                  {% if option.value == collection.sort_by %}checked{% endif %}
                >
                {{ option.name }}
              </label>
            {% endfor %}
          </div>
        </fieldset>
      </div>

    {% endcase %}
  {% endfor %}

  <div class="filter-actions hide">
    <button type="button" id="applyFiltersBtn" class="btn btn--apply">
      Apply Filters
    </button>

    <button
      type="button"
      class="btn btn--clear"
      onclick="window.location.href='{{ collection.url }}'">
      Clear All
    </button>
  </div>

</form>
