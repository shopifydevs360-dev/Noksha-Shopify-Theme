<form id="CollectionFilters">

  {% for block in section.blocks %}
    {% case block.type %}

      {% when 'availablity-filter' %}
        {% for filter in collection.filters %}
          {% if filter.label == 'Availability' %}
            <fieldset>
              <legend>Availability</legend>
              {% for value in filter.values %}
                <label>
                  <input
                    type="checkbox"
                    name="{{ value.param_name }}"
                    value="{{ value.value }}"
                    {% if value.active %}checked{% endif %}
                  >
                  {{ value.label }}
                  <span>({{ value.count }})</span>
                </label>
              {% endfor %}
            </fieldset>
          {% endif %}
        {% endfor %}

      {% when 'vendor-filter' %}
        {% for filter in collection.filters %}
          {% if filter.label == 'Brand' or filter.label == 'Vendor' %}
            <fieldset>
              <legend>{{ filter.label }}</legend>
              {% for value in filter.values %}
                <label>
                  <input
                    type="checkbox"
                    name="{{ value.param_name }}"
                    value="{{ value.value }}"
                    {% if value.active %}checked{% endif %}
                  >
                  {{ value.label }}
                  <span>({{ value.count }})</span>
                </label>
              {% endfor %}
            </fieldset>
          {% endif %}
        {% endfor %}

      {% when 'collection-filter' %}
        <fieldset>
          <legend>Collections</legend>
          {% assign menu = linklists[block.settings.collection_menu] %}
          {% if menu.links.size > 0 %}
            {% for link in menu.links %}
              {% assign handle = link.object.handle %}
              <label>
                <input
                  type="radio"
                  name="collection_handle"
                  value="{{ handle }}"
                >
                {{ link.title }}
              </label>
            {% endfor %}
            <label>
              <input type="radio" name="collection_handle" value="" checked>
              All
            </label>
          {% else %}
            <p>No menu selected.</p>
          {% endif %}
        </fieldset>

      {% when 'color-filter' %}
        {% for filter in collection.filters %}
          {% if filter.label == 'Color' %}
            <fieldset>
              <legend>Color</legend>
              {% for value in filter.values %}
                <label>
                  <input
                    type="checkbox"
                    name="{{ value.param_name }}"
                    value="{{ value.value }}"
                    {% if value.active %}checked{% endif %}
                  >
                  {{ value.label }}
                  <span>({{ value.count }})</span>
                </label>
              {% endfor %}
            </fieldset>
          {% endif %}
        {% endfor %}

{% when 'tag-filter' %}

  {% assign allowed_tags = block.settings.custom_filter_tags
    | downcase
    | split: ','
  %}

  {% for filter in collection.filters %}
    {% if filter.param_name contains '.tag' %}
      <fieldset class="filter filter--tags">
        <legend>{{ block.settings.filter_title }}</legend>

        {% for value in filter.values %}
          {% assign tag_label = value.label | downcase | strip %}

          {% if allowed_tags contains tag_label %}
            <label>
              <input
                type="checkbox"
                name="{{ value.param_name }}"
                value="{{ value.value }}"
                {% if value.active %}checked{% endif %}
              >
              {{ value.label }}
              <span>({{ value.count }})</span>
            </label>
          {% endif %}
        {% endfor %}
      </fieldset>
    {% endif %}
  {% endfor %}


        {% when 'price-filter' %}
          {% for filter in collection.filters %}
            {% if filter.type == 'price_range' %}
              <fieldset>
                <legend>{{ block.settings.filter_title }}</legend>

                <label>
                  Min
                <input
                  type="number"
                  name="{{ filter.min_value.param_name }}"
                  value="{{ filter.min_value.value }}"
                  min="0"
                  max="{{ filter.range_max }}"
                  placeholder="{{ 0 | money_without_trailing_zeros }}"
                >
                </label>

                <label>
                  Max
                <input
                  type="number"
                  name="{{ filter.max_value.param_name }}"
                  value="{{ filter.max_value.value }}"
                  min="0"
                  max="{{ filter.range_max }}"
                  placeholder="{{ filter.range_max | money_without_trailing_zeros }}"
                >

                </label>
              </fieldset>
            {% endif %}
          {% endfor %}


      {% when 'product-type-filter' %}
        {% assign types = block.settings.product_types | split: ',' %}
        <fieldset>
          <legend>{{ block.settings.filter_title }}</legend>
          {% for type in types %}
            {% assign clean_type = type | strip %}
            {% if clean_type != blank %}
              <label>
                <input
                  type="checkbox"
                  name="filter.p.product_type"
                  value="{{ clean_type }}"
                >
                {{ clean_type }}
              </label>
            {% endif %}
          {% endfor %}
        </fieldset>

{% when 'size-filter' %}

  {% for filter in collection.filters %}
    {% if filter.type == 'list' and filter.label == block.settings.filter_title %}
      {% assign custom_sizes = block.settings.sizes %}
      
      {% comment %} DEBUG OUTPUT - make visible {% endcomment %}
      <div style="background: #f0f0f0; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc;">
        <strong>DEBUG INFO:</strong><br>
        Filter title: {{ block.settings.filter_title }}<br>
        Custom sizes setting: <strong>"{{ custom_sizes }}"</strong><br>
        Is custom_sizes blank? {{ custom_sizes | blank }}<br><br>
        
        <strong>All available sizes from Shopify:</strong><br>
        {% for value in filter.values %}
          • "{{ value.label }}" (param: {{ value.param_name }}, value: {{ value.value }}, count: {{ value.count }})<br>
        {% endfor %}
      </div>

      <fieldset class="filter filter--size">
        <legend>{{ block.settings.filter_title }}</legend>

        {% for value in filter.values %}
          {% assign display_this_size = true %}
          
          {% if custom_sizes != blank %}
            {% assign custom_sizes_array = custom_sizes | split: ',' %}
            {% assign found_size = false %}
            
            {% comment %} DEBUG: Show what we're comparing {% endcomment %}
            <div style="background: #fff8dc; padding: 5px; margin: 5px 0; border: 1px dashed #ccc; font-size: 12px;">
              <strong>Checking:</strong> "{{ value.label }}"<br>
              <strong>Against custom sizes:</strong> 
              {% for custom_size in custom_sizes_array %}
                "{{ custom_size }}"{% unless forloop.last %}, {% endunless %}
              {% endfor %}
            </div>
            
            {% assign normalized_value_label = value.label | strip | downcase %}
            
            {% for custom_size in custom_sizes_array %}
              {% assign normalized_custom_size = custom_size | strip | downcase %}
              
              {% comment %} DEBUG: Show each comparison {% endcomment %}
              <div style="background: #e8f5e8; padding: 3px; margin: 2px 0; font-size: 11px;">
                Comparing: "{{ normalized_value_label }}" vs "{{ normalized_custom_size }}" → 
                {% if normalized_value_label == normalized_custom_size %}
                  <span style="color: green;">MATCH!</span>
                {% else %}
                  <span style="color: red;">NO MATCH</span>
                {% endif %}
              </div>
              
              {% if normalized_value_label == normalized_custom_size %}
                {% assign found_size = true %}
                {% break %}
              {% endif %}
            {% endfor %}
            
            {% unless found_size %}
              {% assign display_this_size = false %}
              <div style="background: #ffe6e6; padding: 5px; margin: 5px 0; border: 1px solid #ff9999;">
                ❌ NOT DISPLAYING: "{{ value.label }}" - Not in custom sizes list
              </div>
            {% endunless %}
          {% endif %}
          
          {% if display_this_size %}
            <div style="background: #e6ffe6; padding: 5px; margin: 5px 0; border: 1px solid #99cc99;">
              ✅ DISPLAYING: "{{ value.label }}"
            </div>
            <label>
              <input
                type="checkbox"
                name="{{ value.param_name }}"
                value="{{ value.value }}"
                {% if value.active %}checked{% endif %}
              >
              {{ value.label }}
              <span>({{ value.count }})</span>
            </label>
          {% endif %}
        {% endfor %}
      </fieldset>
    {% endif %}
  {% endfor %}

    {% endcase %}
  {% endfor %}

  <button type="button" id="clearFiltersBtn">Clear All</button>

</form>
