<form id="CollectionFilters">
  
  {% for block in section.blocks %}
    {% case block.type %}
      
      {% when 'availablity-filter' %}
        {% assign availability_filter = false %}
        {% for filter in collection.filters %}
          {% if filter.param_name == 'filter.v.availability' %}
            {% assign availability_filter = filter %}
          {% endif %}
        {% endfor %}
        
        {% if availability_filter %}
          <fieldset class="filter filter--availability">
            <legend>{{ availability_filter.label }}</legend>
            {% for value in availability_filter.values %}
              <label class="filter-label">
                <input
                  type="checkbox"
                  name="{{ value.param_name }}"
                  value="{{ value.value }}"
                  {% if value.active %}checked{% endif %}
                >
                {{ value.label }}
                <span>({{ value.count }})</span>
              </label>
            {% endfor %}
          </fieldset>
        {% endif %}

      {% when 'vendor-filter' %}
        {% assign vendor_filter = false %}
        {% for filter in collection.filters %}
          {% if filter.param_name == 'filter.v.vendor' %}
            {% assign vendor_filter = filter %}
          {% endif %}
        {% endfor %}
        
        {% if vendor_filter %}
          <fieldset class="filter filter--vendor">
            <legend>{{ vendor_filter.label | default: 'Vendor' }}</legend>
            {% for value in vendor_filter.values %}
              <label class="filter-label">
                <input
                  type="checkbox"
                  name="{{ value.param_name }}"
                  value="{{ value.value }}"
                  {% if value.active %}checked{% endif %}
                >
                {{ value.label }}
                <span>({{ value.count }})</span>
              </label>
            {% endfor %}
          </fieldset>
        {% endif %}

      {% when 'collection-filter' %}
        {% if block.settings.collection_menu %}
          <fieldset class="filter filter--collection">
            <legend>Collections</legend>
            {% assign menu = linklists[block.settings.collection_menu] %}
            {% if menu and menu.links.size > 0 %}
              {% for link in menu.links %}
                {% if link.type == 'collection_link' and link.object %}
                  <label class="filter-label">
                    <input
                      type="radio"
                      name="collection_handle"
                      value="{{ link.object.handle }}"
                      {% if collection.handle == link.object.handle %}checked{% endif %}
                    >
                    {{ link.title }}
                  </label>
                {% endif %}
              {% endfor %}
              <label class="filter-label">
                <input type="radio" name="collection_handle" value="" {% unless collection.handle %}checked{% endunless %}>
                All Collections
              </label>
            {% else %}
              <p>No menu selected or menu is empty.</p>
            {% endif %}
          </fieldset>
        {% endif %}

      {% when 'color-filter' %}
        {% assign color_filter = false %}
        {% for filter in collection.filters %}
          {% if filter.param_name contains 'filter.v.option.color' or filter.label == 'Color' or filter.label == 'Colour' %}
            {% assign color_filter = filter %}
          {% endif %}
        {% endfor %}
        
        {% if color_filter %}
          <fieldset class="filter filter--color">
            <legend>{{ block.settings.filter_title | default: color_filter.label }}</legend>
            
            {% assign allow_colors = block.settings.allow_colors | downcase | split: ',' %}
            {% assign disallow_colors = block.settings.disallow_colors | downcase | split: ',' %}
            
            {% for value in color_filter.values %}
              {% assign value_label_lower = value.label | downcase %}
              
              {% comment %} Check if color is allowed/disallowed {% endcomment %}
              {% assign show_color = true %}
              
              {% if allow_colors.size > 0 and allow_colors.first != blank %}
                {% unless allow_colors contains value_label_lower %}
                  {% assign show_color = false %}
                {% endunless %}
              {% endif %}
              
              {% if disallow_colors contains value_label_lower %}
                {% assign show_color = false %}
              {% endif %}
              
              {% if show_color %}
                <label class="filter-label color-filter-label">
                  <input
                    type="checkbox"
                    name="{{ value.param_name }}"
                    value="{{ value.value }}"
                    {% if value.active %}checked{% endif %}
                  >
                  {% comment %} Add color swatch if possible {% endcomment %}
                  {% assign color_swatch = value.label | handle %}
                  <div class="color-swatch" style="background-color: {{ value.label }}; background-color: var(--color-{{ color_swatch }}, {{ value.label }})"></div>
                  {{ value.label }}
                  <span>({{ value.count }})</span>
                </label>
              {% endif %}
            {% endfor %}
          </fieldset>
        {% endif %}

      {% when 'tag-filter' %}
        {% assign tag_filter = false %}
        {% for filter in collection.filters %}
          {% if filter.param_name contains 'filter.p.tag' %}
            {% assign tag_filter = filter %}
          {% endif %}
        {% endfor %}
        
        {% if tag_filter and block.settings.custom_filter_tags %}
          <fieldset class="filter filter--tags">
            <legend>{{ block.settings.filter_title | default: 'Tags' }}</legend>

            {% assign allowed_tags = block.settings.custom_filter_tags | split: ',' %}
            {% assign allowed_tags_lower = block.settings.custom_filter_tags | downcase | split: ',' %}
            
            {% for value in tag_filter.values %}
              {% assign value_label_lower = value.label | downcase %}
              {% if allowed_tags_lower contains value_label_lower %}
                <label class="filter-label">
                  <input
                    type="checkbox"
                    name="{{ value.param_name }}"
                    value="{{ value.value }}"
                    {% if value.active %}checked{% endif %}
                  >
                  {{ value.label }}
                  <span>({{ value.count }})</span>
                </label>
              {% endif %}
            {% endfor %}
          </fieldset>
        {% endif %}

      {% when 'price-filter' %}
        {% assign price_filter = false %}
        {% for filter in collection.filters %}
          {% if filter.type == 'price_range' %}
            {% assign price_filter = filter %}
          {% endif %}
        {% endfor %}
        
        {% if price_filter %}
          <fieldset class="filter filter--price price-filter">
            <legend>{{ block.settings.filter_title | default: 'Price' }}</legend>
            
            <div class="price-input">
              <label>
                Min:
                <input
                  type="number"
                  name="{{ price_filter.min_value.param_name }}"
                  value="{{ price_filter.min_value.value | divided_by: 100 | default: '' }}"
                  min="0"
                  max="{{ price_filter.range_max | divided_by: 100 }}"
                  placeholder="0"
                  step="1"
                >
              </label>
              <label>
                Max:
                <input
                  type="number"
                  name="{{ price_filter.max_value.param_name }}"
                  value="{{ price_filter.max_value.value | divided_by: 100 | default: '' }}"
                  min="0"
                  max="{{ price_filter.range_max | divided_by: 100 }}"
                  placeholder="{{ price_filter.range_max | divided_by: 100 }}"
                  step="1"
                >
              </label>
            </div>
            
            <div class="range-input">
              <input
                type="range"
                class="min-range"
                min="0"
                max="{{ price_filter.range_max | divided_by: 100 }}"
                value="{{ price_filter.min_value.value | divided_by: 100 | default: 0 }}"
                data-param="{{ price_filter.min_value.param_name }}"
              >
              <input
                type="range"
                class="max-range"
                min="0"
                max="{{ price_filter.range_max | divided_by: 100 }}"
                value="{{ price_filter.max_value.value | divided_by: 100 | default: price_filter.range_max | divided_by: 100 }}"
                data-param="{{ price_filter.max_value.param_name }}"
              >
            </div>
            
            <div class="price-display">
              Price: <span class="min-display">{{ price_filter.min_value.value | default: 0 | money }}</span> - <span class="max-display">{{ price_filter.max_value.value | default: price_filter.range_max | money }}</span>
            </div>
          </fieldset>
        {% endif %}

      {% when 'product-type-filter' %}
        {% assign product_type_filter = false %}
        {% for filter in collection.filters %}
          {% if filter.param_name == 'filter.p.product_type' %}
            {% assign product_type_filter = filter %}
          {% endif %}
        {% endfor %}
        
        {% if product_type_filter %}
          <fieldset class="filter filter--product-type">
            <legend>{{ block.settings.filter_title | default: 'Product Type' }}</legend>
            
            {% if block.settings.product_types %}
              {% assign allowed_types = block.settings.product_types | split: ',' %}
              {% assign allowed_types_lower = block.settings.product_types | downcase | split: ',' %}
              
              {% for value in product_type_filter.values %}
                {% assign value_label_lower = value.label | downcase %}
                {% if allowed_types_lower contains value_label_lower %}
                  <label class="filter-label">
                    <input
                      type="checkbox"
                      name="{{ value.param_name }}"
                      value="{{ value.value }}"
                      {% if value.active %}checked{% endif %}
                    >
                    {{ value.label }}
                    <span>({{ value.count }})</span>
                  </label>
                {% endif %}
              {% endfor %}
            {% else %}
              {% for value in product_type_filter.values %}
                <label class="filter-label">
                  <input
                    type="checkbox"
                    name="{{ value.param_name }}"
                    value="{{ value.value }}"
                    {% if value.active %}checked{% endif %}
                  >
                  {{ value.label }}
                  <span>({{ value.count }})</span>
                </label>
              {% endfor %}
            {% endif %}
          </fieldset>
        {% endif %}

      {% when 'size-filter' %}
        {% assign size_filter = false %}
        {% for filter in collection.filters %}
          {% if filter.param_name contains 'filter.v.option.size' or filter.label == 'Size' %}
            {% assign size_filter = filter %}
          {% endif %}
        {% endfor %}
        
        {% if size_filter %}
          <fieldset class="filter filter--size">
            <legend>{{ block.settings.filter_title | default: 'Size' }}</legend>
            
            {% if block.settings.sizes %}
              {% assign allowed_sizes = block.settings.sizes | split: ',' %}
              {% assign allowed_sizes_lower = block.settings.sizes | downcase | split: ',' %}
              
              {% for value in size_filter.values %}
                {% assign value_label_lower = value.label | downcase %}
                {% if allowed_sizes_lower contains value_label_lower %}
                  <label class="filter-label">
                    <input
                      type="checkbox"
                      name="{{ value.param_name }}"
                      value="{{ value.value }}"
                      {% if value.active %}checked{% endif %}
                    >
                    {{ value.label }}
                    <span>({{ value.count }})</span>
                  </label>
                {% endif %}
              {% endfor %}
            {% else %}
              {% for value in size_filter.values %}
                <label class="filter-label">
                  <input
                    type="checkbox"
                    name="{{ value.param_name }}"
                    value="{{ value.value }}"
                    {% if value.active %}checked{% endif %}
                  >
                  {{ value.label }}
                  <span>({{ value.count }})</span>
                </label>
              {% endfor %}
            {% endif %}
          </fieldset>
        {% endif %}

    {% endcase %}
  {% endfor %}

  {% if section.blocks.size > 0 %}
    <div class="filter-buttons">
      <button type="button" id="clearFiltersBtn" class="clear-filters-btn">Clear All</button>
      <button type="submit" class="apply-filters-btn">Apply Filters</button>
    </div>
  {% endif %}

</form>

{% if section.blocks.size == 0 %}
  <p>No filters configured. Add filter blocks in the section settings.</p>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Price range slider functionality
  const minRange = document.querySelector('.min-range');
  const maxRange = document.querySelector('.max-range');
  const minInput = document.querySelector('input[name*="filter.v.price.gte"]');
  const maxInput = document.querySelector('input[name*="filter.v.price.lte"]');
  
  if (minRange && maxRange && minInput && maxInput) {
    function updatePriceInputs() {
      minInput.value = minRange.value;
      maxInput.value = maxRange.value;
    }
    
    minRange.addEventListener('input', updatePriceInputs);
    maxRange.addEventListener('input', updatePriceInputs);
  }
});
</script>