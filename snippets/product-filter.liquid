<div class="filters-wrapper">
  <div class="filters-header">
    <h2>Filters</h2>
    <button type="button" class="filters-close-btn" aria-label="Close filters">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>
  </div>

  <form id="CollectionFilters" class="collection-filters-form">
    {% for block in section.blocks %}
      {% case block.type %}
        {% when 'availablity-filter' %}
          {% for filter in collection.filters %}
            {% if filter.label == 'Availability' %}
              <div class="filter-group" {{ block.shopify_attributes }}>
                <h3>Availability</h3>
                {% for value in filter.values %}
                  <label class="filter-label">
                    <input
                      type="checkbox"
                      name="{{ value.param_name }}"
                      value="{{ value.value }}"
                      {% if value.active %}checked{% endif %}
                      {% if value.count == 0 and value.active == false %}disabled{% endif %}
                    >
                    <span>{{ value.label }} ({{ value.count }})</span>
                  </label>
                {% endfor %}
              </div>
            {% endif %}
          {% endfor %}

        {% when 'vendor-filter' %}
          {% for filter in collection.filters %}
            {% if filter.label == 'Brand' or filter.label == 'Vendor' %}
              <div class="filter-group" {{ block.shopify_attributes }}>
                <h3>{{ filter.label }}</h3>
                {% for value in filter.values %}
                  <label class="filter-label">
                    <input
                      type="checkbox"
                      name="{{ value.param_name }}"
                      value="{{ value.value }}"
                      {% if value.active %}checked{% endif %}
                      {% if value.count == 0 and value.active == false %}disabled{% endif %}
                    >
                    <span>{{ value.label }} ({{ value.count }})</span>
                  </label>
                {% endfor %}
              </div>
            {% endif %}
          {% endfor %}

        {% when 'collection-filter' %}
          {% assign menu = linklists[block.settings.collection_menu] %}
          {% if menu.links.size > 0 %}
            <div class="filter-group" {{ block.shopify_attributes }}>
              <h3>Collections</h3>
              {% for link in menu.links %}
                {% if link.type == 'collection_link' %}
                  {% assign handle = link.object.handle %}
                  <label class="filter-label">
                    <input
                      type="radio"
                      name="collection_handle"
                      value="{{ handle }}"
                      {% if collection.handle == handle %}checked{% endif %}
                    >
                    <span>{{ link.title }}</span>
                  </label>
                {% endif %}
              {% endfor %}
              <label class="filter-label">
                <input type="radio" name="collection_handle" value="" {% unless collection.handle %}checked{% endunless %}>
                <span>All</span>
              </label>
            </div>
          {% endif %}

        {% when 'color-filter' %}
          {% assign allow_colors = block.settings.allow_colors | downcase | split: ',' %}
          {% assign disallow_colors = block.settings.disallow_colors | downcase | split: ',' %}
          
          {% for filter in collection.filters %}
            {% if filter.label == 'Color' %}
              <div class="filter-group color-filter-group" {{ block.shopify_attributes }}>
                <h3>{{ block.settings.filter_title | default: 'Color' }}</h3>
                {% for value in filter.values %}
                  {% assign value_lower = value.label | downcase | strip %}
                  {% assign should_show = true %}
                  
                  {% comment %} Check if color is in allow list {% endcomment %}
                  {% if allow_colors.size > 0 %}
                    {% assign color_is_allowed = false %}
                    {% for allowed_color in allow_colors %}
                      {% assign clean_allowed = allowed_color | strip %}
                      {% if clean_allowed == value_lower %}
                        {% assign color_is_allowed = true %}
                        {% break %}
                      {% endif %}
                    {% endfor %}
                    {% if color_is_allowed == false %}
                      {% assign should_show = false %}
                    {% endif %}
                  {% endif %}
                  
                  {% comment %} Check if color is in disallow list {% endcomment %}
                  {% if disallow_colors.size > 0 and should_show %}
                    {% for disallowed_color in disallow_colors %}
                      {% assign clean_disallowed = disallowed_color | strip %}
                      {% if clean_disallowed == value_lower %}
                        {% assign should_show = false %}
                        {% break %}
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                  
                  {% if should_show %}
                    <label class="filter-label color-filter-label">
                      <input
                        type="checkbox"
                        name="{{ value.param_name }}"
                        value="{{ value.value }}"
                        {% if value.active %}checked{% endif %}
                        {% if value.count == 0 and value.active == false %}disabled{% endif %}
                      >
                      <span class="color-swatch" style="background-color: {{ value.label | handleize }};"></span>
                      <span>{{ value.label }} ({{ value.count }})</span>
                    </label>
                  {% endif %}
                {% endfor %}
              </div>
            {% endif %}
          {% endfor %}

        {% when 'tag-filter' %}
          {% assign allowed_tags_string = block.settings.custom_filter_tags | downcase %}
          {% assign allowed_tags = allowed_tags_string | split: ',' %}
          
          {% for filter in collection.filters %}
            {% if filter.param_name contains '.tag' %}
              <div class="filter-group tag-filter-group" {{ block.shopify_attributes }}>
                <h3>{{ block.settings.filter_title | default: 'Tags' }}</h3>
                
                {% for value in filter.values %}
                  {% assign tag_label = value.label | downcase | strip %}
                  {% assign tag_should_show = false %}
                  
                  {% if allowed_tags.size == 0 %}
                    {% assign tag_should_show = true %}
                  {% else %}
                    {% comment %} Check if tag is in allowed list {% endcomment %}
                    {% for allowed_tag in allowed_tags %}
                      {% assign clean_allowed_tag = allowed_tag | strip %}
                      {% if clean_allowed_tag == tag_label %}
                        {% assign tag_should_show = true %}
                        {% break %}
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                  
                  {% if tag_should_show %}
                    <label class="filter-label">
                      <input
                        type="checkbox"
                        name="{{ value.param_name }}"
                        value="{{ value.value }}"
                        {% if value.active %}checked{% endif %}
                        {% if value.count == 0 and value.active == false %}disabled{% endif %}
                      >
                      <span>{{ value.label }} ({{ value.count }})</span>
                    </label>
                  {% endif %}
                {% endfor %}
              </div>
            {% endif %}
          {% endfor %}

        {% when 'price-filter' %}
          {% for filter in collection.filters %}
            {% if filter.type == 'price_range' %}
              <div class="filter-group price-filter-group" {{ block.shopify_attributes }}>
                <h3>{{ block.settings.filter_title | default: 'Price' }}</h3>
                <div class="price-input">
                  <label class="price-label">
                    <span>Min</span>
                    <input
                      type="number"
                      name="{{ filter.min_value.param_name }}"
                      value="{{ filter.min_value.value | divided_by: 100 }}"
                      min="0"
                      max="{{ filter.range_max | divided_by: 100 }}"
                      placeholder="0"
                      class="price-min-input"
                    >
                  </label>
                  <span class="price-separator">-</span>
                  <label class="price-label">
                    <span>Max</span>
                    <input
                      type="number"
                      name="{{ filter.max_value.param_name }}"
                      value="{{ filter.max_value.value | divided_by: 100 }}"
                      min="0"
                      max="{{ filter.range_max | divided_by: 100 }}"
                      placeholder="{{ filter.range_max | divided_by: 100 }}"
                      class="price-max-input"
                    >
                  </label>
                </div>
                <div class="price-range-slider">
                  <input
                    type="range"
                    class="price-slider"
                    min="0"
                    max="{{ filter.range_max | divided_by: 100 }}"
                    value="{{ filter.min_value.value | default: 0 | divided_by: 100 }}"
                    data-min-input
                  >
                  <input
                    type="range"
                    class="price-slider"
                    min="0"
                    max="{{ filter.range_max | divided_by: 100 }}"
                    value="{{ filter.max_value.value | default: filter.range_max | divided_by: 100 }}"
                    data-max-input
                  >
                </div>
              </div>
            {% endif %}
          {% endfor %}

        {% when 'product-type-filter' %}
          {% assign types_string = block.settings.product_types %}
          {% assign types = types_string | split: ',' %}
          {% if types.size > 0 %}
            <div class="filter-group product-type-filter-group" {{ block.shopify_attributes }}>
              <h3>{{ block.settings.filter_title | default: 'Product Type' }}</h3>
              
              {% for filter in collection.filters %}
                {% if filter.param_name contains '.product_type' %}
                  {% for value in filter.values %}
                    {% assign type_lower = value.label | downcase | strip %}
                    {% assign should_show = false %}
                    
                    {% if types.size == 0 %}
                      {% assign should_show = true %}
                    {% else %}
                      {% comment %} Check if product type is in allowed list {% endcomment %}
                      {% for type in types %}
                        {% assign clean_type = type | strip | downcase %}
                        {% if clean_type == type_lower %}
                          {% assign should_show = true %}
                          {% break %}
                        {% endif %}
                      {% endfor %}
                    {% endif %}
                    
                    {% if should_show %}
                      <label class="filter-label">
                        <input
                          type="checkbox"
                          name="{{ value.param_name }}"
                          value="{{ value.value }}"
                          {% if value.active %}checked{% endif %}
                          {% if value.count == 0 and value.active == false %}disabled{% endif %}
                        >
                        <span>{{ value.label }} ({{ value.count }})</span>
                      </label>
                    {% endif %}
                  {% endfor %}
                {% endif %}
              {% endfor %}
            </div>
          {% endif %}

        {% when 'size-filter' %}
          {% assign allowed_sizes_string = block.settings.sizes %}
          {% assign allowed_sizes = allowed_sizes_string | split: ',' %}
          
          {% for filter in collection.filters %}
            {% if filter.label == block.settings.filter_title or filter.label == 'Size' %}
              <div class="filter-group size-filter-group" {{ block.shopify_attributes }}>
                <h3>{{ block.settings.filter_title | default: 'Size' }}</h3>
                
                {% for value in filter.values %}
                  {% assign size_lower = value.label | downcase | strip %}
                  {% assign should_show = true %}
                  
                  {% if allowed_sizes.size > 0 %}
                    {% assign size_found = false %}
                    {% for size in allowed_sizes %}
                      {% assign clean_size = size | strip | downcase %}
                      {% if clean_size == size_lower %}
                        {% assign size_found = true %}
                        {% break %}
                      {% endif %}
                    {% endfor %}
                    {% unless size_found %}
                      {% assign should_show = false %}
                    {% endunless %}
                  {% endif %}
                  
                  {% if should_show %}
                    <label class="filter-label">
                      <input
                        type="checkbox"
                        name="{{ value.param_name }}"
                        value="{{ value.value }}"
                        {% if value.active %}checked{% endif %}
                        {% if value.count == 0 and value.active == false %}disabled{% endif %}
                      >
                      <span>{{ value.label }} ({{ value.count }})</span>
                    </label>
                  {% endif %}
                {% endfor %}
              </div>
            {% endif %}
          {% endfor %}

      {% endcase %}
    {% endfor %}

    <div class="filter-actions">
      <button type="button" id="clearFiltersBtn" class="btn btn-secondary">
        Clear All
      </button>
      <button type="submit" class="btn btn-primary">
        Apply Filters
      </button>
    </div>
  </form>
</div>