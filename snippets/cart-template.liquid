{{ 'cart-template.css' | asset_url | stylesheet_tag }}

{% assign free_shipping_threshold = settings.free_shipping_threshold | times: 100 %}
{% assign discount_threshold = settings.order_discount_threshold | times: 100 %}



<div class="cart-template" data-cart-root data-free-shipping-threshold="{{ free_shipping_threshold }}" data-discount-threshold="{{ discount_threshold }}">
  <div class="container">
    <form action="{{ routes.cart_url }}" method="post" novalidate>
      <div class="cart-template__inner">

        <!-- LEFT -->
        <div class="cart-template-left">

          <h4 class="cart-title">Your Bag</h4>

          <!-- FREE SHIPPING -->
          {% if settings.enable_free_shipping %}
            {% assign remaining = free_shipping_threshold | minus: cart.total_price %}
            {% assign progress = cart.total_price | times: 100 | divided_by: free_shipping_threshold %}
            {% if progress > 100 %}{% assign progress = 100 %}{% endif %}

            <div class="cart-shipping-wrapper">

              {% if remaining > 0 %}
                <p>
                  You are <strong>{{ remaining | money }}</strong>
                  away from free shipping
                </p>
              {% else %}
                <p class="success-text">ðŸŽ‰ Youâ€™ve unlocked free shipping!</p>
              {% endif %}

              <div class="shipping-progress">
                <div class="shipping-progress-bar" style="width: {{ progress }}%;"></div>
              </div>

            </div>
          {% endif %}
          <!-- Discount unlock -->
          {% if settings.enable_order_discount %}
            {% assign discount_remaining = discount_threshold | minus: cart.total_price %}
            {% assign discount_progress = cart.total_price | times: 100 | divided_by: discount_threshold %}
            {% if discount_progress > 100 %}
              {% assign discount_progress = 100 %}
            {% endif %}

            <div class="cart-discount-wrapper"
                data-discount-threshold="{{ discount_threshold }}">

              {% if discount_remaining > 0 %}
                <p>
                  Spend
                  <span class="cart-discount-remaining">
                    {{ discount_remaining | money }}
                  </span>
                  more to unlock special discount
                </p>
              {% else %}
                <p class="success-text">ðŸ”¥ Discount unlocked!</p>
              {% endif %}

              <!-- âœ… PROGRESS BAR -->
              <div class="discount-progress">
                <div class="discount-progress-bar"
                    style="width: {{ discount_progress }}%;">
                </div>
              </div>

            </div>
          {% endif %}



          {% if cart.item_count > 0 %}
            <div class="cart-list-items">
            {% for item in cart.items %}
              {% render 'cart-items', item: item %}
            {% endfor %}
            </div>
          {% else %}
            <p class="cart-empty-message">Your cart is currently empty.</p>
            <a href="{{ shop.url }}" class="continue-shopping">
              Continue Shopping
            </a>
          {% endif %}
        </div>

        <!-- RIGHT -->
        <div class="cart-template-right">

          <h4>Order Summary</h4>

          <div class="cart-summary-row">
            <h5 class="sub-total">Subtotal</h5>
            <span class="cart-subtotal">
              {{ cart.items_subtotal_price | money }}
            </span>
          </div>

          <button type="submit" name="checkout" class="cart-checkout-btn">
            Checkout
          </button>

          <p class="cart-note">
            Shipping and taxes calculated at checkout.
          </p>
          {% if settings.show_discount_code %}
            <div class="cart-coupon">
              <input type="text" id="coupon-code" placeholder="Enter coupon code">
              <button type="button" id="apply-coupon-btn">Apply</button>
              <p class="coupon-message"></p>
            </div>
          {% endif %}


        </div>

      </div>
    </form>
  </div>
</div>

<script src="{{ 'cart-template.js' | asset_url }}" defer></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {

  const applyBtn = document.getElementById('apply-coupon-btn');

  if (applyBtn) {
    applyBtn.addEventListener('click', function() {

      const code = document.getElementById('coupon-code').value.trim();
      const message = document.querySelector('.coupon-message');

      if (!code) {
        message.textContent = "Please enter a code.";
        return;
      }

      fetch('/discount/' + code)
        .then(() => {
          message.textContent = "Coupon applied!";
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        })
        .catch(() => {
          message.textContent = "Invalid coupon code.";
        });

    });
  }

});

</script>
