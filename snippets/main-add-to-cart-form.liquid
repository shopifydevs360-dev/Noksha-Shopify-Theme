<div class="product-block product-form-wrapper" {{ block.shopify_attributes }}>
  {% form 'product', product, class: 'product-form' %}
        {% assign current_variant = product.selected_or_first_available_variant %}
    <!-- REQUIRED VARIANT ID (CRITICAL) -->
    <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
    <!-- VARIANTS -->
    <div class="variant-selector">
      {% render 'product-variant-picker', product: product %}
    </div>
    <div class="qty-cart-btn-wrap">
      <!-- QUANTITY -->
      <div class="quantity-dropdown" data-qty-dropdown>
        <button type="button" class="qty-toggle" data-qty-toggle>
          Qty 1
        </button>

        <ul class="qty-list">
          {% assign quantities = "1,2,3,4,5,6" | split: "," %}
          {% for qty in quantities %}
            <li
              class="qty-item {% if forloop.first %}is-selected{% endif %}"
              data-qty="{{ qty }}"
            >
              Qty {{ qty }}
            </li>
          {% endfor %}
        </ul>

        <!-- Hidden input for Shopify -->
        <input type="hidden" name="quantity" value="1">
      </div>


      <!-- ADD TO CART -->
      <div class="product-actions" data-cart-behavior="{{ block.settings.cart_behavior }}">
        <button
          type="submit"
          class="btn-add-to-cart"
          data-role="add-to-cart"
          {% unless current_variant.available %}disabled{% endunless %}
        >
          {% if current_variant.available %}
            Add to cart
          {% else %}
            Out of stock
          {% endif %}
        </button>
      </div>
    </div>

    <!-- BUY / NOTIFY -->
    <div class="quick-checkout">
      <button
        type="button"
        class="btn-buy-now {% unless current_variant.available %}hide{% endunless %}"
        data-role="buy-now"
      >
        Buy it now
      </button>

      <button
        type="button"
        class="btn-notify {% if current_variant.available %}hide{% endif %}"
        data-role="notify"
      >
        Notify me when available
      </button>
    </div>

  {% endform %}

</div>
<script type="application/json" id="ProductVariantsJson">
  {{ product.variants | json }}
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {

  const variants = JSON.parse(document.getElementById('ProductVariantsJson').textContent);
  const mainMediaWrapper = document.getElementById('MainProductMedia');

  function getSelectedOptions() {
    const selected = [];
    document.querySelectorAll('.main-product-variant-selector fieldset').forEach(fieldset => {
      const checked = fieldset.querySelector('input:checked');
      const select = fieldset.querySelector('select');
      if (checked) selected.push(checked.value);
      else if (select) selected.push(select.value);
    });
    return selected;
  }

  function findMatchingVariant(options) {
    return variants.find(variant => {
      return variant.options.every((opt, index) => opt === options[index]);
    });
  }

  function updateMainImage(variant) {
    if (!variant || !variant.featured_media) return;

    const newImage = `
      <img 
        src="${variant.featured_media.preview_image.src}" 
        alt="${variant.featured_media.alt || ''}"
        class="js-open-lightbox"
      />
    `;

    mainMediaWrapper.innerHTML = newImage;
  }

  document.querySelectorAll('.main-product-variant-selector input, .main-product-variant-selector select')
    .forEach(el => {
      el.addEventListener('change', function () {
        const selectedOptions = getSelectedOptions();
        const matchedVariant = findMatchingVariant(selectedOptions);
        updateMainImage(matchedVariant);
      });
    });

});
</script>
