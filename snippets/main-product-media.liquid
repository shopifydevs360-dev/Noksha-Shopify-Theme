{%- liquid
  if product == blank
    echo 'Product media unavailable'
    break
  endif
  assign media_count = product.media.size

-%}

<div class="product-media">

  <!-- =====================
       MAIN MEDIA
  ====================== -->
<div class="product-media__main swiper hide-tablet hide-mobile hide-tablet-landscape" id="MainProductMedia">

  <div class="swiper-wrapper">

    {% assign rendered_media_ids = '' %}

    {% for variant in product.variants %}
      {% if variant.featured_media %}
        {% assign media_id = variant.featured_media.id | append: '' %}

        {% unless rendered_media_ids contains media_id %}
          {% assign rendered_media_ids = rendered_media_ids | append: media_id | append: ',' %}

          <div class="swiper-slide" data-media-id="{{ variant.featured_media.id }}">
            {% render 'image',
              class: 'js-open-lightbox',
              image: variant.featured_media,
              width: variant.featured_media.width,
              height: variant.featured_media.height,
              crop: 'center',
              img_alt: variant.featured_media.alt,
              style: wrapper_style
            %}
          </div>

        {% endunless %}
      {% endif %}
    {% endfor %}

  </div>
</div>



  <!-- =====================
       VIDEO ROW (IF EXISTS)
  ====================== -->
  {% assign has_video = false %}
  {% for media in product.media %}
    {% if media.media_type contains 'video' %}
      {% assign has_video = true %}
      {% break %}
    {% endif %}
  {% endfor %}

  {% if has_video %}
    <div class="product-media__video-row hide-tablet hide-mobile hide-tablet-landscape">
      {% for media in product.media %}
        {% if media.media_type contains 'video' %}
          <div class="product-media__video js-open-lightbox">
            {{ media | video_tag:
              autoplay: true,
              loop: true,
              muted: true,
              controls: false,
              playsinline: true,
              preload: 'metadata'
            }}
          </div>
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}

{% if media_count > 1 %}
  <div class="product-media__thumbs swiper">
    <div class="swiper-wrapper">

      {%- comment -%}
      First pass: render all images EXCEPT the first
      {%- endcomment -%}
      {% for media in product.media offset: 1 %}
        {% if media.media_type == 'image' %}
          <div class="swiper-slide">
          {% render 'image',
            class: 'js-open-lightbox',
            image: media,
            crop: 'center',
            width: media.width,
            height: media.height,
            img_alt: media.alt
          %}

          </div>
        {% endif %}
      {% endfor %}

      {%- comment -%}
      Second pass: render the FIRST image at the end
      {%- endcomment -%}
      {% assign first_media = product.media.first %}
      {% if first_media.media_type == 'image' %}
        <div class="swiper-slide">
        {% render 'image',
          class: 'js-open-lightbox',
          image: first_media,
          crop: 'center',
          width: first_media.width,
          height: first_media.height,
          img_alt: first_media.alt,
          data_lightbox_index: product.media.size | minus: 1
        %}
        </div>
      {% endif %}

    </div>

    <div class="swiper-nav-wrapper">
      <button class="swiper-button-prev" aria-label="Previous slide">
        <span class="inner-text h5">Previous</span>
      </button>

      <button class="swiper-button-next" aria-label="Next slide">
        <span class="line"></span>
        <span class="inner-text h5">Next</span>
      </button>
    </div>

    <div class="swiper-pagination"></div>
  </div>
{% endif %}


</div>

<!-- =====================
     LIGHTBOX
====================== -->
<div class="media-lightbox" id="mediaLightbox">
  <div class="media-lightbox__overlay"></div>

  <div class="media-lightbox__content">
    <button class="media-lightbox__close" aria-label="Close">Ã—</button>

    <div class="swiper media-lightbox__slider">
      <div class="swiper-wrapper">

        {% for media in product.media %}
          {% if media.media_type == 'image' %}
            <div class="swiper-slide">
              {% render 'image',
                image: media,
                width: media.width,
                height: media.height,
                img_alt: media.alt,
                loading: 'eager'
              %}
            </div>
          {% endif %}
        {% endfor %}

      </div>

      <div class="swiper-button-prev"></div>
      <div class="swiper-button-next"></div>
      <div class="swiper-pagination"></div>
    </div>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function () {

  const variants = JSON.parse(
    document.getElementById('ProductVariantsJson').textContent
  );

  const mainSwiper = new Swiper('#MainProductMedia', {
    loop: true,
    slidesPerView: 1,
    spaceBetween: 0,
    autoHeight: true,
    effect: 'fade',
    fadeEffect: {
      crossFade: true
    },
  });

  function getSelectedOptions() {
    const selected = [];
    document.querySelectorAll('.main-product-variant-selector fieldset')
      .forEach(fieldset => {
        const checked = fieldset.querySelector('input:checked');
        const select = fieldset.querySelector('select');
        if (checked) selected.push(checked.value);
        else if (select) selected.push(select.value);
      });
    return selected;
  }

  function findMatchingVariant(options) {
    return variants.find(variant => {
      return variant.options.every((opt, index) => opt === options[index]);
    });
  }

  function slideToVariant(variant) {
    if (!variant || !variant.featured_media) return;

    const mediaId = variant.featured_media.id;

    // IMPORTANT: Only select ORIGINAL slides (not duplicated loop slides)
    const slides = document.querySelectorAll(
      '#MainProductMedia .swiper-slide:not(.swiper-slide-duplicate)'
    );

    slides.forEach((slide, index) => {
      if (slide.dataset.mediaId == mediaId) {
        mainSwiper.slideToLoop(index); // ðŸ”¥ required for loop mode
      }
    });
  }

  document.querySelectorAll(
    '.main-product-variant-selector input, .main-product-variant-selector select'
  ).forEach(el => {
    el.addEventListener('change', function () {
      const selectedOptions = getSelectedOptions();
      const matchedVariant = findMatchingVariant(selectedOptions);
      slideToVariant(matchedVariant);
    });
  });

});
</script>