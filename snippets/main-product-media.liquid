{%- liquid
  if product == blank
    echo 'Product media unavailable'
    break
  endif

  assign variant_media = product.selected_or_first_available_variant.featured_media
  assign first_media = product.media.first
  assign media_count = product.media.size
-%}

<div class="product-media">

  <!-- =====================
       MAIN SWIPER (UPDATED)
  ====================== -->
  <div class="product-media__main swiper hide-tablet hide-mobile hide-tablet-landscape">
    <div class="swiper-wrapper">

      {%- comment -%}
      1️⃣ Variant image first (if exists)
      {%- endcomment -%}
      {% if variant_media %}
        <div class="swiper-slide" data-media-id="{{ variant_media.id }}">
          {% render 'image',
            class: 'js-open-lightbox',
            image: variant_media,
            width: variant_media.width,
            height: variant_media.height,
            crop: 'center',
            img_alt: variant_media.alt
          %}
        </div>
      {% endif %}

      {%- comment -%}
      2️⃣ First product image (if different from variant)
      {%- endcomment -%}
      {% if first_media and first_media.id != variant_media.id %}
        <div class="swiper-slide" data-media-id="{{ first_media.id }}">
          {% render 'image',
            class: 'js-open-lightbox',
            image: first_media,
            width: first_media.width,
            height: first_media.height,
            crop: 'center',
            img_alt: first_media.alt
          %}
        </div>
      {% endif %}

      {%- comment -%}
      3️⃣ Rest of gallery images (excluding variant and first if already shown)
      {%- endcomment -%}
      {% for media in product.media %}
        {% if media.media_type == 'image'
          and media.id != variant_media.id
          and media.id != first_media.id
        %}
          <div class="swiper-slide" data-media-id="{{ media.id }}">
            {% render 'image',
              class: 'js-open-lightbox',
              image: media,
              width: media.width,
              height: media.height,
              crop: 'center',
              img_alt: media.alt
            %}
          </div>
        {% endif %}
      {% endfor %}

    </div>

    <div class="swiper-button-prev"></div>
    <div class="swiper-button-next"></div>
    <div class="swiper-pagination"></div>
  </div>


  <!-- =====================
       VIDEO ROW (IF EXISTS)
  ====================== -->
  {% assign has_video = false %}
  {% for media in product.media %}
    {% if media.media_type contains 'video' %}
      {% assign has_video = true %}
      {% break %}
    {% endif %}
  {% endfor %}

  {% if has_video %}
    <div class="product-media__video-row hide-tablet hide-mobile hide-tablet-landscape">
      {% for media in product.media %}
        {% if media.media_type contains 'video' %}
          <div class="product-media__video js-open-lightbox">
            {{ media | video_tag:
              autoplay: true,
              loop: true,
              muted: true,
              controls: false,
              playsinline: true,
              preload: 'metadata'
            }}
          </div>
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}

{% if media_count > 1 %}
  <div class="product-media__thumbs swiper">
    <div class="swiper-wrapper">

      {%- comment -%}
      First pass: render all images EXCEPT the first
      {%- endcomment -%}
      {% for media in product.media offset: 1 %}
        {% if media.media_type == 'image' %}
          <div class="swiper-slide">
          {% render 'image',
            class: 'js-open-lightbox',
            image: media,
            crop: 'center',
            width: media.width,
            height: media.height,
            img_alt: media.alt
          %}

          </div>
        {% endif %}
      {% endfor %}

      {%- comment -%}
      Second pass: render the FIRST image at the end
      {%- endcomment -%}
      {% assign first_media = product.media.first %}
      {% if first_media.media_type == 'image' %}
        <div class="swiper-slide">
        {% render 'image',
          class: 'js-open-lightbox',
          image: first_media,
          crop: 'center',
          width: first_media.width,
          height: first_media.height,
          img_alt: first_media.alt,
          data_lightbox_index: product.media.size | minus: 1
        %}
        </div>
      {% endif %}

    </div>

    <div class="swiper-nav-wrapper">
      <button class="swiper-button-prev" aria-label="Previous slide">
        <span class="inner-text h5">Previous</span>
      </button>

      <button class="swiper-button-next" aria-label="Next slide">
        <span class="line"></span>
        <span class="inner-text h5">Next</span>
      </button>
    </div>

    <div class="swiper-pagination"></div>
  </div>
{% endif %}


</div>

<!-- =====================
     LIGHTBOX
====================== -->
<div class="media-lightbox" id="mediaLightbox">
  <div class="media-lightbox__overlay"></div>

  <div class="media-lightbox__content">
    <button class="media-lightbox__close" aria-label="Close">×</button>

    <div class="swiper media-lightbox__slider">
      <div class="swiper-wrapper">

        {% for media in product.media %}
          {% if media.media_type == 'image' %}
            <div class="swiper-slide">
              {% render 'image',
                image: media,
                width: media.width,
                height: media.height,
                img_alt: media.alt,
                loading: 'eager'
              %}
            </div>
          {% endif %}
        {% endfor %}

      </div>

      <div class="swiper-button-prev"></div>
      <div class="swiper-button-next"></div>
      <div class="swiper-pagination"></div>
    </div>
  </div>
</div>