<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
{% render 'section-base-style' %}
{% liquid
  assign first_class = 'store-location-section ' | append: 'm-color-' | append: section.settings.color_scheme 
  assign first_class = first_class | append: ' ' | append: section.settings.color_control
  assign first_class = first_class | append: ' ' | append: section.settings.custom_class
  assign first_class = first_class | append: ' ' | append: 'section-' | append: section.id | append: '-padding'
  assign container_width = section.settings.container_width
%}

<div class="{{ first_class }}" id="store-location-{{ section.id }}">
  <div class="{{ container_width }}">
    <div class="inner-section {% if section.settings.enable_sidebar_space %}sidebar-space{% endif %}">
        <div class="hero-info text-{{ section.settings.text_align }}">
            <h1 class="hero-title {{ section.settings.title_font_size }}">{{ section.settings.hero_title }}</h1>
            <div class="hero-description">{{ section.settings.hero_description }}</div>
        </div>
      {% if section.blocks.size > 0 %}
        <div class="tabs">
          {% for block in section.blocks %}
            <button
              class="tab-button {% if forloop.first %}active{% endif %}"
              data-tab="tab-{{ section.id }}-{{ forloop.index }}"
              {{ block.shopify_attributes }}
            >
              {{ block.settings.tab_title }}
            </button>
          {% endfor %}
        </div>

        {% for block in section.blocks %}
          <div
            id="tab-{{ section.id }}-{{ forloop.index }}"
            class="tab-content {% if forloop.first %}active{% endif %}"
          >
            <div class="location-info">
              <h4 class="store-name">{{ block.settings.store_name }}</h4>

              <div class="details">
                <ul>
                    <li>
                        <span class="icon">{%- render 'theme-icon', icon: 'location' -%}</span>
                        <span class="label">Location:</span>
                        <span class="detail">{{ block.settings.location }}</span>
                    </li>
                    <li>
                        <span class="icon">{%- render 'theme-icon', icon: 'hour' -%}</span>
                        <span class="label">Opening Hours:</span>
                        <span class="detail">{{ block.settings.hours }}</span>
                    </li>
                    <li>
                        <span class="icon">{%- render 'theme-icon', icon: 'phone' -%}</span>
                        <span class="label">Contact:</span>
                        <span class="detail">{{ block.settings.contact }}</span>
                    </li>
                    <li class="store-detail">{{ block.settings.description }}</li>
                    <li>
                        <a href="" class="get-direction">
                            <span class="icon">{%- render 'theme-icon', icon: 'arrow-direction' -%}</span>
                            <span class="text">Get Directions</span>
                        </a>
                    </li>
                </ul>
              </div>
            </div>

            <div
              class="map-container"
              id="map-{{ section.id }}-{{ forloop.index }}"
              data-coordinates="{{ block.settings.coordinates }}"
              data-title="{{ block.settings.store_name }}"
            ></div>
          </div>
        {% endfor %}
      {% endif %}
    </div>
  </div>
</div>

{% stylesheet %}
.store-location-section .tabs {
  display: flex;
  flex-wrap: wrap;
  border-bottom: 1px solid rgb(var(--color-border));
}

.store-location-section .tab-button {
  flex: 1;
  padding: 1rem;
  background: transparent;
  border: none;
  cursor: pointer;
  transition: 0.3s;
  font-weight: 500;
}

.store-location-section .tab-button.active {
  border-bottom: 3px solid rgb(var(--color-heading));
  font-weight: 600;
}

.store-location-section .tab-content {
  display: none;
  gap: 3rem;
  padding: 2rem 0;
}

.store-location-section .tab-content.active {
  display: flex;
  flex-wrap: wrap;
}

.store-location-section .location-info {
  flex: 1;
  min-width: 280px;
}

.store-location-section .map-container {
  flex: 1;
  min-width: 300px;
  height: 400px;
}

{% endstylesheet %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

  const section = document.getElementById("store-location-{{ section.id }}");
  if (!section) return;

  const buttons = section.querySelectorAll(".tab-button");
  const contents = section.querySelectorAll(".tab-content");
  let maps = {};

  function openTab(button) {
    const tabId = button.dataset.tab;

    contents.forEach(c => c.classList.remove("active"));
    buttons.forEach(b => b.classList.remove("active"));

    button.classList.add("active");
    const activeTab = section.querySelector("#" + tabId);
    activeTab.classList.add("active");

    // Use setTimeout to ensure the tab is visible before initializing the map
    setTimeout(() => initializeMap(activeTab), 100);
  }

    function initializeMap(tab) {
    const mapContainer = tab.querySelector(".map-container");
    const mapId = mapContainer.id;

    if (maps[mapId]) {
        setTimeout(() => maps[mapId].invalidateSize(), 100);
        return;
    }

    const coordString = mapContainer.dataset.coordinates;
    const title = mapContainer.dataset.title;

    if (!coordString) return;

    const parts = coordString.split(",");
    if (parts.length !== 2) return;

    const lat = parseFloat(parts[0].trim());
    const lng = parseFloat(parts[1].trim());

    if (isNaN(lat) || isNaN(lng)) return;

    const map = L.map(mapId).setView([lat, lng], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    L.marker([lat, lng]).addTo(map).bindPopup(title).openPopup();

    maps[mapId] = map;
    }


  buttons.forEach(button => {
    button.addEventListener("click", function () {
      openTab(this);
    });
  });

  // Init first tab
  const firstTab = section.querySelector(".tab-content.active");
  if (firstTab) {
    // Use setTimeout to ensure the tab is visible before initializing the map
    setTimeout(() => initializeMap(firstTab), 100);
  }

});
</script>

{% schema %}
{
  "name": "Store Location Tabs",
  "settings": [
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "checkbox",
      "id": "enable_sidebar_space",
      "label": "Enable sidebar space",
      "default": true
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme"
    },
    {
      "type": "select",
      "id": "container_width",
      "label": "Container width",
      "options": [
        { "value": "container", "label": "Container" },
        { "value": "container-fluid", "label": "Container fluid" },
        { "value": "container-narrow", "label": "Container narrow" },
        { "value": "container-extra-narrow", "label": "Container extra narrow" },
        { "value": "extended", "label": "Extended" }
      ],
      "default": "extended"
    },
    {
        "type": "text",
        "id": "hero_title",
        "label": "Hero Title",
        "default": "Qatar Shopping Malls Directory"
    },
    {
      "type": "select",
      "id": "title_font_size",
      "label": "Font size",
      "options": [
        { "value": "h1", "label": "h1" },
        { "value": "h2", "label": "h2" },
        { "value": "h3", "label": "h3" },
        { "value": "h4", "label": "h4" },
      ],
      "default": "h3"
    },
    {
        "type": "richtext",
        "id": "hero_description",
        "label": "Hero description",
        "default": "<p>Explore premier shopping destinations across Qatar</p>"
    },
    {
      "type": "select",
      "id": "text_align",
      "label": "Text align",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" },
      ],
      "default": "center"
    },
    {
      "type": "header",
      "content": "Section padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Top padding",
      "default": 40
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Bottom padding",
      "default": 52
    },
    {
      "type": "text",
      "id": "custom_class",
      "label": "Custom class"
    },
    {
      "type": "select",
      "id": "color_control",
      "label": "Color Control",
      "options": [
        { "value": "section-dark", "label": "Dark" },
        { "value": "section-light", "label": "Light" }
      ],
      "default": "section-light"
    }
  ],
  "blocks": [
    {
      "type": "location",
      "name": "Store Location",
      "settings": [
        { "type": "text", "id": "tab_title", "label": "Tab Title" },
        { "type": "text", "id": "store_name", "label": "Store Name" },
        { "type": "text", "id": "location", "label": "Location" },
        { "type": "text", "id": "hours", "label": "Opening Hours" },
        { "type": "text", "id": "contact", "label": "Contact" },
        { "type": "richtext", "id": "description", "label": "Description" },
        { "type": "text", "id": "coordinates", "label": "Map Coordinates", "info": "Get coordinates from Google Maps → Right click → What's here? Example: 25.2854, 51.5310  (Latitude, Longitude)", "default": "25.2651, 51.4758" }

      ]
    }
  ],
  "presets": [
    {
      "name": "Store Location Tabs"
    }
  ]
}
{% endschema %}