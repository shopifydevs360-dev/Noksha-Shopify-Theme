{{ 'related-product-tab.css' | asset_url | stylesheet_tag }}
{% render 'section-base-style' %}

{%- liquid
  assign current_product = product
  assign related_collection = current_product.collections.first
  assign has_related = false
  assign has_recommended = false

  if related_collection and related_collection.products_count > 1
    assign has_related = true
  endif

  if recommendations.performed and recommendations.products_count > 0
    assign has_recommended = true
  endif
-%}

{% if has_related or has_recommended %}

<div class="product-tabs-carousel js-product-carousel-{{ section.id }} {{ section.settings.color_control }} {{ section.settings.custom_class }} m-color-{{ section.settings.color_scheme }}">
  <div class="product-carousel section-{{ section.id }}-padding">

    <!-- ================= MOBILE TITLE ================= -->
    <h2 class="container hide-desktop hide-large-screens {{ section.settings.title_font_size }}">
      <div data-reveal="lines-masked" class="info-title">
        {{ section.settings.title }}
      </div>
    </h2>

    <!-- ================= FILTER TABS ================= -->
    <div class="swiper swiper-container-filter">
      <div class="swiper-wrapper">

        {% if has_related %}
        <div class="related-product-caps swiper-slide active">
          <a href="#" class="js-slider-filter" data-filter="related">
            Related Products
          </a>
        </div>
        {% endif %}

        {% if has_recommended %}
        <div class="related-product-caps swiper-slide {% unless has_related %}active{% endunless %}">
          <a href="#" class="js-slider-filter" data-filter="recommended">
            You May Like
          </a>
        </div>
        {% endif %}

      </div>
    </div>

    <!-- ================= PRODUCTS CAROUSEL ================= -->
    <div class="swiper swiper-container-product">
      <div class="swiper-wrapper">

        <!-- Desktop Lead Card (EXACT SAME AS YOUR ORIGINAL) -->
        <div class="swiper-slide v-aligner hide-tablet hide-mobile hide-tablet-landscape">
          <div class="collection-lead-info">
            <h2 class="{{ section.settings.title_font_size }}">
              <div data-reveal="lines-masked" class="info-title">
                {{ section.settings.title }}
              </div>
            </h2>
          </div>
        </div>

        <!-- Related Products -->
        {% if has_related %}
          {% for product in related_collection.products limit: 8 %}
            {% unless product.id == current_product.id %}
              <div
                class="swiper-slide product-slide"
                data-collection="related"
              >
                {% render 'product-card', product: product %}
              </div>
            {% endunless %}
          {% endfor %}
        {% endif %}

        <!-- Recommended Products -->
        {% if has_recommended %}
          {% for product in recommendations.products limit: 8 %}
            <div
              class="swiper-slide product-slide"
              data-collection="recommended"
              {% if has_related %}hidden{% endif %}
            >
              {% render 'product-card', product: product %}
            </div>
          {% endfor %}
        {% endif %}

      </div>

      <div class="swiper-scrollbar hide-desktop hide-large-screens"></div>
    </div>

  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const section = document.querySelector('.js-product-carousel-{{ section.id }}');
  if (!section) return;

  const tabs = section.querySelectorAll('.js-slider-filter');
  const slides = section.querySelectorAll('.product-slide');

  /* ---------------- FILTER TABS SWIPER ---------------- */
  new Swiper(section.querySelector('.swiper-container-filter'), {
    slidesPerView: 'auto',
    freeMode: true,
    spaceBetween: 40
  });

  /* ---------------- PRODUCTS SWIPER ---------------- */
  const productSwiper = new Swiper(section.querySelector('.swiper-container-product'), {
    slidesPerView: 1.2,
    scrollbar: {
      el: section.querySelector('.swiper-scrollbar'),
      draggable: true
    },
    breakpoints: {
      580: { slidesPerView: 2.5 },
      991: { slidesPerView: 3 },
      1321: { slidesPerView: 3.5 }
    },
    on: {
      slideChangeTransitionEnd() {
        animateVisibleCards();
      }
    }
  });

  /* ---------------- ANIMATION HANDLER ---------------- */
  function animateVisibleCards() {
    // Remove animation from all cards
    section.querySelectorAll('.product-card').forEach(card => {
      card.classList.remove('is-animated');
    });

    // Force reflow (important for restarting CSS animation)
    void section.offsetHeight;

    // Animate only visible cards
    section.querySelectorAll(
      '.product-slide[style*="display: block"] .product-card'
    ).forEach(card => {
      card.classList.add('is-animated');
    });
  }

  /* ---------------- ASSIGN VISIBLE INDEX ---------------- */
  function updateVisibleIndexes() {
    const visibleSlides = Array.from(slides).filter(
      slide => slide.style.display === 'block'
    );

    visibleSlides.forEach((slide, index) => {
      slide.setAttribute('item-index', index + 1);
    });
  }

  /* ---------------- TAB ACTIVATION ---------------- */
  function activateTab(filter, tab) {

    // Active tab UI
    section.querySelectorAll('.related-product-caps')
      .forEach(el => el.classList.remove('active'));

    tab.closest('.related-product-caps').classList.add('active');

    // Hide all slides
    slides.forEach(slide => {
      slide.style.display = 'none';
      slide.removeAttribute('item-index');

      slide.querySelectorAll('.product-card').forEach(card => {
        card.classList.remove('is-animated');
      });
    });

    // Show selected slides
    slides.forEach(slide => {
      if (slide.dataset.collection === filter) {
        slide.style.display = 'block';
      }
    });

    // Assign fresh indexes
    updateVisibleIndexes();

    // Reset swiper position
    productSwiper.update();
    productSwiper.slideTo(0, 0);

    // Animate visible cards
    animateVisibleCards();
  }

  /* ---------------- INIT FIRST TAB ---------------- */
  if (tabs.length) {
    activateTab(tabs[0].dataset.filter, tabs[0]);
  }

  /* ---------------- TAB CLICK EVENTS ---------------- */
  tabs.forEach(tab => {
    tab.addEventListener('click', e => {
      e.preventDefault();
      activateTab(tab.dataset.filter, tab);
    });
  });

});
</script>


{% endif %}

{% schema %}
{
  "name": "Product Related Tabs",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "You May Also Like"
    },
    {
      "type": "select",
      "id": "title_font_size",
      "label": "Font size",
      "options": [
        { "value": "h1", "label": "h1" },
        { "value": "h2", "label": "h2" },
        { "value": "h3", "label": "h3" },
        { "value": "h4", "label": "h4" }
      ],
      "default": "h3"
    },
    {
      "type": "text",
      "id": "custom_class",
      "label": "Custom class"
    },
    {
      "type": "select",
      "id": "color_control",
      "label": "Color Control",
      "options": [
        { "value": "section-dark", "label": "Dark" },
        { "value": "section-light", "label": "Light" }
      ],
      "default": "section-light"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Top padding",
      "default": 40
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Bottom padding",
      "default": 52
    }
  ],
  "presets": [
    {
      "name": "Product Related Tabs",
      "category": "Product"
    }
  ]
}
{% endschema %}
