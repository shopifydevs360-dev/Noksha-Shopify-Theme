{{ 'collection-tab.css' | asset_url | stylesheet_tag }}
{% render 'section-base-style' %}

{% liquid
  assign current_product = product
  assign related_collection = current_product.collections.first

  assign related_products = related_collection.products | where: "id", current_product.id, false
  assign related_count = 0

  if related_collection
    for p in related_collection.products
      if p.id != current_product.id
        assign related_count = related_count | plus: 1
      endif
    endfor
  endif
%}

{% capture recommendations %}
  {% render 'product-recommendations',
    product_id: product.id,
    limit: 6
  %}
{% endcapture %}

{% assign has_recommendations = false %}
{% if recommendations contains 'product-card' %}
  {% assign has_recommendations = true %}
{% endif %}

{% if related_count > 0 or has_recommendations %}

<div class="product-tabs-carousel js-product-carousel-{{ section.id }} m-color-{{ section.settings.color_scheme }}">
  <div class="product-carousel section-{{ section.id }}-padding">

    <!-- ================= FILTER TABS ================= -->
    <div class="swiper swiper-container-filter">
      <div class="swiper-wrapper">

        {% if related_count > 0 %}
        <div class="related-product-caps swiper-slide active">
          <a href="#" class="js-slider-filter" data-filter="related">
            Related Products
          </a>
        </div>
        {% endif %}

        {% if has_recommendations %}
        <div class="related-product-caps swiper-slide {% unless related_count > 0 %}active{% endunless %}">
          <a href="#" class="js-slider-filter" data-filter="recommended">
            You May Also Like
          </a>
        </div>
        {% endif %}

      </div>
    </div>

    <!-- ================= PRODUCTS CAROUSEL ================= -->
    <div class="swiper swiper-container-product">
      <div class="swiper-wrapper">

        <!-- Related Products -->
        {% if related_collection %}
          {% for p in related_collection.products limit: 6 %}
            {% if p.id != current_product.id %}
              <div
                class="swiper-slide product-slide"
                data-type="related"
                {% unless forloop.first %}hidden{% endunless %}
              >
                {% render 'product-card', product: p %}
              </div>
            {% endif %}
          {% endfor %}
        {% endif %}

        <!-- Recommended Products -->
        {% if has_recommendations %}
          <div class="recommended-wrapper" data-type="recommended" hidden>
            {{ recommendations }}
          </div>
        {% endif %}

      </div>

      <div class="swiper-scrollbar hide-desktop hide-large-screens"></div>
    </div>

  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

  const section = document.querySelector('.js-product-carousel-{{ section.id }}');
  if (!section) return;

  const tabs = section.querySelectorAll('.js-slider-filter');
  const slides = section.querySelectorAll('.product-slide');
  const recommendedWrapper = section.querySelector('[data-type="recommended"]');

  new Swiper(section.querySelector('.swiper-container-filter'), {
    slidesPerView: 'auto',
    freeMode: true,
    spaceBetween: 40
  });

  const productSwiper = new Swiper(section.querySelector('.swiper-container-product'), {
    slidesPerView: 1.2,
    scrollbar: {
      el: section.querySelector('.swiper-scrollbar'),
      draggable: true
    },
    breakpoints: {
      580: { slidesPerView: 2.5 },
      991: { slidesPerView: 3 },
      1321: { slidesPerView: 3.5 }
    }
  });

  function activateTab(type, tab) {

    section.querySelectorAll('.related-product-caps')
      .forEach(el => el.classList.remove('active'));
    tab.closest('.related-product-caps').classList.add('active');

    slides.forEach(slide => slide.style.display = 'none');

    if (recommendedWrapper) {
      recommendedWrapper.hidden = true;
    }

    if (type === 'related') {
      slides.forEach(slide => {
        if (slide.dataset.type === 'related') {
          slide.style.display = 'block';
        }
      });
    }

    if (type === 'recommended' && recommendedWrapper) {
      recommendedWrapper.hidden = false;
    }

    productSwiper.update();
    productSwiper.slideTo(0, 0);
  }

  if (tabs.length) {
    activateTab(tabs[0].dataset.filter, tabs[0]);
  }

  tabs.forEach(tab => {
    tab.addEventListener('click', e => {
      e.preventDefault();
      activateTab(tab.dataset.filter, tab);
    });
  });

});
</script>

{% endif %}

{% schema %}
{
  "name": "Product Related Tabs",
  "settings": [
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Top padding",
      "default": 40
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Bottom padding",
      "default": 52
    }
  ],
  "presets": [
    {
      "name": "Product Related Tabs",
      "category": "Products"
    }
  ]
}
{% endschema %}
